stages:
  - validate
  - plan
  - apply

variables:
  TERRAFORM_VERSION: "1.5"
  TF_ROOT: "${CI_PROJECT_DIR}/DevOps/environments/dev"
  # Vault configuration - set these in GitLab CI/CD Variables
  # VAULT_ADDR: https://vault-xxxxx.vault.11b0221a.budgets.hcp-demo.com
  # VAULT_JWT_ROLE: gitlab-role
  # VAULT_SECRET_PATH: secret/data/azure/terraform/arm

image: 
  name: hashicorp/terraform:${TERRAFORM_VERSION}
  entrypoint: [""]

before_script:
  - cd ${TF_ROOT}
  
  # Fetch secrets from Vault using GitLab JWT
  - |
    if [ -n "$VAULT_ADDR" ] && [ -n "$VAULT_JWT_ROLE" ]; then
      echo "üîê Authenticating with Vault..."
      
      # Get JWT token from GitLab OIDC
      export VAULT_TOKEN=$(curl -s --request POST \
        --data @- ${VAULT_ADDR}/v1/auth/jwt/login \
        <<< "{\"role\":\"${VAULT_JWT_ROLE}\",\"jwt\":\"${CI_JOB_JWT}\"}" \
        | jq -r '.auth.client_token')
      
      if [ "$VAULT_TOKEN" != "null" ] && [ -n "$VAULT_TOKEN" ]; then
        echo "‚úÖ Vault authentication successful"
        
        # Retrieve ARM credentials from Vault
        export VAULT_SECRET=$(curl -s -H "X-Vault-Token: $VAULT_TOKEN" \
          "${VAULT_ADDR}/v1/${VAULT_SECRET_PATH}")
        
        export ARM_CLIENT_ID=$(echo $VAULT_SECRET | jq -r '.data.data.client_id // empty')
        export ARM_CLIENT_SECRET=$(echo $VAULT_SECRET | jq -r '.data.data.client_secret // empty')
        export ARM_SUBSCRIPTION_ID=$(echo $VAULT_SECRET | jq -r '.data.data.subscription_id // empty')
        export ARM_TENANT_ID=$(echo $VAULT_SECRET | jq -r '.data.data.tenant_id // empty')
        
        if [ -z "$ARM_CLIENT_ID" ]; then
          echo "‚ùå Failed to retrieve secrets from Vault"
          exit 1
        fi
        echo "‚úÖ Secrets retrieved from Vault"
      else
        echo "‚ùå Failed to authenticate with Vault"
        exit 1
      fi
    else
      echo "‚ö†Ô∏è  Vault not configured. Using GitLab variables as fallback..."
    fi
  
  - terraform --version

# Validate Terraform code on every push
validate:
  stage: validate
  script:
    - echo "üîç Validating Terraform configuration..."
    - terraform init -backend=false
    - terraform validate
    - terraform fmt -check -recursive ../../terraform/
  only:
    - merge_requests
    - main
  allow_failure: false

# Format check
format_check:
  stage: validate
  script:
    - echo "üìã Checking Terraform format..."
    - terraform fmt -check -recursive ../../
  only:
    - merge_requests
    - main
  allow_failure: true

# Plan changes
plan:
  stage: plan
  script:
    - echo "üìä Running Terraform plan..."
    - terraform init
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - ${TF_ROOT}/tfplan
    reports:
      terraform: ${TF_ROOT}/plan.json
    expire_in: 7 days
  only:
    - merge_requests
    - main
  environment:
    name: dev
    action: prepare

# Auto-apply on push to main
apply:
  stage: apply
  script:
    - echo "üöÄ Applying Terraform configuration..."
    - terraform init
    - terraform apply -auto-approve tfplan
    - echo ""
    - echo "‚úÖ Deployment successful!"
    - echo ""
    - echo "Cluster Details:"
    - terraform output
  dependencies:
    - plan
  only:
    - main
  when: manual
  environment:
    name: dev
    action: prepare
    deployment_tier: production

# Destroy environment (manual only - safety measure)
destroy:
  stage: apply
  script:
    - echo "‚ö†Ô∏è  Destroying Terraform-managed resources..."
    - terraform init
    - terraform destroy -auto-approve
    - echo "‚úÖ Destroy complete"
  only:
    - main
  when: manual
  environment:
    name: dev
    action: stop
