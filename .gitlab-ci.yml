stages:
  - validate
  - plan
  - apply
  - destroy

variables:
  TERRAFORM_VERSION: "1.5"

image: 
  name: hashicorp/terraform:${TERRAFORM_VERSION}
  entrypoint: [""]

before_script:
  - apk add --no-cache python3 py3-pip curl bash
  - pip3 install --upgrade pip
  - pip3 install azure-cli
  - az login --service-principal -u "${ARM_CLIENT_ID}" -p "${ARM_CLIENT_SECRET}" --tenant "${ARM_TENANT_ID}"
  - terraform --version
  - export TF_VAR_azure_client_id="${ARM_CLIENT_ID}"
  - export TF_VAR_azure_client_secret="${ARM_CLIENT_SECRET}"
  - export TF_VAR_azure_subscription_id="${ARM_SUBSCRIPTION_ID}"
  - export TF_VAR_azure_tenant_id="${ARM_TENANT_ID}"
  - if [ -n "$TF_ROOT" ]; then cd "$TF_ROOT"; fi

# Validate Terraform code on every push
validate:
  stage: validate
  script:
    - echo "üîç Validating Terraform configuration..."
    - cd ${CI_PROJECT_DIR}/DevOps/environments/dev && terraform init -backend=false && terraform validate
    - cd ${CI_PROJECT_DIR}/DevOps/environments/preprod && terraform init -backend=false && terraform validate
    - terraform fmt -check -recursive ${CI_PROJECT_DIR}/DevOps/
  only:
    - merge_requests
    - main
  allow_failure: false

# Format check
format_check:
  stage: validate
  script:
    - echo "üìã Checking Terraform format..."
    - terraform fmt -check -recursive ${CI_PROJECT_DIR}/DevOps/
  only:
    - merge_requests
    - main
  allow_failure: true

# ==== DEV ENVIRONMENT ====

plan_dev:
  stage: plan
  variables:
    TF_ROOT: "${CI_PROJECT_DIR}/DevOps/environments/dev"
  script:
    - echo "üìä Planning DEV environment..."
    - terraform init
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - ${TF_ROOT}/tfplan
    reports:
      terraform: ${TF_ROOT}/plan.json
    expire_in: 7 days
  only:
    - main
  environment:
    name: dev
    action: prepare

apply_dev:
  stage: apply
  variables:
    TF_ROOT: "${CI_PROJECT_DIR}/DevOps/environments/dev"
  script:
    - echo "üöÄ Applying DEV environment..."
    - terraform init
    - rm -f tfplan  # Delete old plan in case code changed
    - terraform plan -out=tfplan
    - terraform apply -auto-approve tfplan
    - echo ""
    - echo "‚úÖ DEV Deployment successful!"
    - echo ""
    - echo "Cluster Details:"
    - terraform output
  dependencies:
    - plan_dev
  only:
    - main
  when: manual
  environment:
    name: dev
    action: prepare
    deployment_tier: production

destroy_dev:
  stage: destroy
  variables:
    TF_ROOT: "${CI_PROJECT_DIR}/DevOps/environments/dev"
  script:
    - echo "‚ö†Ô∏è  Destroying DEV environment..."
    - terraform init
    - terraform destroy -auto-approve
    - echo "‚úÖ DEV destroy complete"
  only:
    - main
  when: manual
  environment:
    name: dev
    action: stop

# ==== PREPROD ENVIRONMENT ====

plan_preprod:
  stage: plan
  variables:
    TF_ROOT: "${CI_PROJECT_DIR}/DevOps/environments/preprod"
  script:
    - echo "üìä Planning PREPROD environment..."
    - terraform init
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - ${TF_ROOT}/tfplan
    reports:
      terraform: ${TF_ROOT}/plan.json
    expire_in: 7 days
  only:
    - main
  when: manual
  environment:
    name: preprod
    action: prepare

apply_preprod:
  stage: apply
  variables:
    TF_ROOT: "${CI_PROJECT_DIR}/DevOps/environments/preprod"
  script:
    - echo "üöÄ Applying PREPROD environment..."
    - terraform init
    - rm -f tfplan  # Delete old plan in case code changed
    - terraform plan -out=tfplan
    - terraform apply -auto-approve tfplan
    - echo ""
    - echo "‚úÖ PREPROD Deployment successful!"
    - echo ""
    - echo "Cluster Details:"
    - terraform output
  dependencies:
    - plan_preprod
  only:
    - main
  when: manual
  environment:
    name: preprod
    action: prepare
    deployment_tier: production

destroy_preprod:
  stage: destroy
  variables:
    TF_ROOT: "${CI_PROJECT_DIR}/DevOps/environments/preprod"
  script:
    - echo "‚ö†Ô∏è  Destroying PREPROD environment..."
    - terraform init
    - terraform destroy -auto-approve
    - echo "‚úÖ PREPROD destroy complete"
  only:
    - main
  when: manual
  environment:
    name: preprod
    action: stop

# ==== TARGETED DESTROY JOBS ====

destroy_aks_dev:
  stage: destroy
  variables:
    TF_ROOT: "${CI_PROJECT_DIR}/DevOps/environments/dev"
  script:
    - echo "‚ö†Ô∏è  Destroying only AKS in DEV (keeping storage account)..."
    - terraform init
    - terraform destroy -target=module.aks -auto-approve
    - echo "‚úÖ DEV AKS destroyed (storage account preserved)"
  only:
    - main
  when: manual
  environment:
    name: dev

destroy_aks_preprod:
  stage: destroy
  variables:
    TF_ROOT: "${CI_PROJECT_DIR}/DevOps/environments/preprod"
  script:
    - echo "‚ö†Ô∏è  Destroying only AKS in PREPROD (keeping storage account)..."
    - terraform init
    - terraform destroy -target=module.aks -auto-approve
    - echo "‚úÖ PREPROD AKS destroyed (storage account preserved)"
  only:
    - main
  when: manual
  environment:
    name: preprod
